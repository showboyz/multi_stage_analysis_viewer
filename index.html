<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©€í‹° ìŠ¤í…Œì´ì§€ ì˜ë£Œ ë¶„ì„ ë·°ì–´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom: 4px solid #667eea;
        }
        .tab-button:not(.active) {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .chart-container {
            height: 350px;
        }
        .small-chart {
            height: 200px;
        }
    </style>
</head>
<body class="min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <!-- í—¤ë” -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-white mb-4">ğŸ¥ ë©€í‹° ìŠ¤í…Œì´ì§€ ì˜ë£Œ ë¶„ì„ ë·°ì–´</h1>
            <p class="text-xl text-purple-200">ì—¬ëŸ¬ ìŠ¤í…Œì´ì§€ë¥¼ ë¹„êµí•˜ê³  ì§„í–‰ ìƒí™©ì„ ì¶”ì í•˜ì„¸ìš”</p>

            <!-- íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="mt-6">
                <input type="file" id="fileInput" accept=".json" class="hidden">
                <button onclick="document.getElementById('fileInput').click()"
                        class="bg-white text-purple-600 px-8 py-4 rounded-xl font-bold text-lg shadow-2xl hover:shadow-3xl hover:scale-105 transition-all">
                    ğŸ“ JSON íŒŒì¼ ì„ íƒ
                </button>
            </div>

            <!-- í™˜ì ì •ë³´ -->
            <div class="mt-6 bg-white/20 backdrop-blur-sm rounded-lg p-4 inline-block" id="patient-info" style="display: none;">
                <div class="grid grid-cols-4 gap-6 text-white">
                    <div>
                        <div class="text-sm opacity-75">í™˜ìëª…</div>
                        <div class="text-2xl font-bold" id="patient-name">-</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-75">ê²Œì„</div>
                        <div class="text-2xl font-bold" id="game-name">-</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-75">ì´ ìŠ¤í…Œì´ì§€</div>
                        <div class="text-2xl font-bold" id="total-stages">0ê°œ</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-75">í‰ê·  ì ìˆ˜</div>
                        <div class="text-2xl font-bold text-green-300" id="avg-score">0ì </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div id="tab-navigation" class="bg-white/10 backdrop-blur-sm rounded-t-2xl p-2 flex gap-2" style="display: none;">
            <button class="tab-button active flex-1 py-4 px-6 rounded-lg font-bold text-lg" data-tab="overview">
                ğŸ“Š ì „ì²´ ë¹„êµ
            </button>
            <button class="tab-button flex-1 py-4 px-6 rounded-lg font-bold text-lg" data-tab="stage1">
                Stage 1
            </button>
            <button class="tab-button flex-1 py-4 px-6 rounded-lg font-bold text-lg" data-tab="stage2">
                Stage 2
            </button>
            <button class="tab-button flex-1 py-4 px-6 rounded-lg font-bold text-lg" data-tab="stage3">
                Stage 3
            </button>
        </div>

        <!-- íƒ­ ì»¨í…ì¸  -->
        <div id="tab-content" class="bg-white rounded-b-2xl shadow-2xl p-8" style="display: none;">
            <!-- ì „ì²´ ë¹„êµ íƒ­ -->
            <div id="overview-tab" class="tab-pane">
                <!-- ìŠ¤ë…¸ë¹„ ìŠ¤í…Œì´ì§€ ì •ë³´ -->
                <div id="snooby-stages-info" class="mb-8" style="display: none;">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ¯ ìŠ¤í…Œì´ì§€ êµ¬ì„±</h3>
                    <div id="stages-info-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>
                </div>

                <!-- ì „ì²´ í‰ê·  -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ¥ 6ê°œ í‰ê°€ ì˜ì—­ ì „ì²´ í‰ê· </h3>
                    <div class="chart-container">
                        <canvas id="overviewRadarChart"></canvas>
                    </div>
                </div>

                <!-- ì ìˆ˜ ë¹„êµ í…Œì´ë¸” -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“Š í‰ê°€ ì˜ì—­ë³„ í‰ê·  ì ìˆ˜</h3>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-gray-800 mb-2">ğŸ’¡ í•´ì„ ê°€ì´ë“œ</h4>
                        <div class="text-sm text-gray-700 space-y-1">
                            <p>â€¢ ëª¨ë“  ìŠ¤í…Œì´ì§€ì™€ BPMì˜ í‰ê·  ì ìˆ˜ë¥¼ ì˜ì—­ë³„ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤</p>
                            <p>â€¢ <span class="font-bold text-green-600">90ì  ì´ìƒ: ìš°ìˆ˜</span> | <span class="font-bold text-blue-600">80-89ì : ì–‘í˜¸</span> | <span class="font-bold text-yellow-600">70-79ì : ë³´í†µ</span> | <span class="font-bold text-orange-600">60-69ì : ë¯¸í¡</span> | <span class="font-bold text-red-600">60ì  ë¯¸ë§Œ: ê°œì„  í•„ìš”</span></p>
                            <p>â€¢ ì ìˆ˜ê°€ ë‚®ì€ ì˜ì—­ì„ ì¤‘ì ì ìœ¼ë¡œ í›ˆë ¨í•˜ë©´ íš¨ê³¼ì ì…ë‹ˆë‹¤</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse" id="comparison-table">
                            <thead>
                                <tr class="bg-gradient-to-r from-blue-100 to-indigo-100">
                                    <th class="border border-gray-300 p-4 text-left font-bold text-gray-800">í‰ê°€ ì˜ì—­</th>
                                    <th class="border border-gray-300 p-4 text-center font-bold text-gray-800">í‰ê·  ì ìˆ˜</th>
                                    <th class="border border-gray-300 p-4 text-center font-bold text-gray-800">ë“±ê¸‰</th>
                                </tr>
                            </thead>
                            <tbody id="comparison-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stage 1 íƒ­ -->
            <div id="stage1-tab" class="tab-pane" style="display: none;">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Stage 1 ìƒì„¸ ë¶„ì„</h2>
                    <div class="flex gap-4 items-center">
                        <span class="text-sm font-semibold text-gray-600">ë¹„êµí•  BPM ì„ íƒ:</span>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="stage-bpm-filter w-4 h-4" data-stage="1" data-bpm="80" checked>
                            <span class="font-semibold">BPM 80</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="stage-bpm-filter w-4 h-4" data-stage="1" data-bpm="100" checked>
                            <span class="font-semibold">BPM 100</span>
                        </label>
                    </div>
                </div>
                <div id="stage1-content"></div>
            </div>

            <!-- Stage 2 íƒ­ -->
            <div id="stage2-tab" class="tab-pane" style="display: none;">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Stage 2 ìƒì„¸ ë¶„ì„</h2>
                    <div class="flex gap-4 items-center">
                        <span class="text-sm font-semibold text-gray-600">ë¹„êµí•  BPM ì„ íƒ:</span>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="stage-bpm-filter w-4 h-4" data-stage="2" data-bpm="80" checked>
                            <span class="font-semibold">BPM 80</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="stage-bpm-filter w-4 h-4" data-stage="2" data-bpm="100" checked>
                            <span class="font-semibold">BPM 100</span>
                        </label>
                    </div>
                </div>
                <div id="stage2-content"></div>
            </div>

            <!-- Stage 3 íƒ­ -->
            <div id="stage3-tab" class="tab-pane" style="display: none;">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Stage 3 ìƒì„¸ ë¶„ì„</h2>
                    <div class="flex gap-4 items-center">
                        <span class="text-sm font-semibold text-gray-600">ë¹„êµí•  BPM ì„ íƒ:</span>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="stage-bpm-filter w-4 h-4" data-stage="3" data-bpm="80" checked>
                            <span class="font-semibold">BPM 80</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="stage-bpm-filter w-4 h-4" data-stage="3" data-bpm="100" checked>
                            <span class="font-semibold">BPM 100</span>
                        </label>
                    </div>
                </div>
                <div id="stage3-content"></div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let charts = {};

        // ìŠ¤ë…¸ë¹„ë³„ Stage ì •ì˜ (generate_html_report.pyì—ì„œ ê°€ì ¸ì˜´)
        const SNOOBY_STAGES = {
            1: {
                "name": "ìŠ¤ë…¸ë¹„ 1",
                "stages": [
                    {"stage": 1, "name": "ì–‘íŒ” êµì°¨ë¡œ ì•ìœ¼ë¡œ í”ë“¤ê¸°", "type": "Upper Limb Cross-Pattern Movement"},
                    {"stage": 2, "name": "ì–‘íŒ” ë“¤ê³  ì¢Œìš°ë¡œ êµ½íˆê¸°", "type": "Bilateral Lateral Flexion Movement"},
                    {"stage": 3, "name": "ì–‘íŒ” êµëŒ€ë¡œ ìœ„ë¡œ ì˜¬ë¦¬ê¸°", "type": "Alternating Shoulder Elevation"}
                ]
            },
            2: {
                "name": "ìŠ¤ë…¸ë¹„ 2",
                "stages": [
                    {"stage": 1, "name": "êµì°¨ë¡œ Vìë¥¼ ê·¸ë¦¬ë©° í”ë“¤ê¸°", "type": "Cross V-Shape Movement"},
                    {"stage": 2, "name": "êµì°¨ë¡œ Aìë¥¼ ê·¸ë¦¬ë©° í”ë“¤ê¸°", "type": "Cross A-Shape Movement"},
                    {"stage": 3, "name": "êµì°¨ë¡œ ë³µí•© ë™ì‘", "type": "Cross Combined Movement"}
                ]
            },
            3: {
                "name": "ìŠ¤ë…¸ë¹„ 3",
                "stages": [
                    {"stage": 1, "name": "Step ìƒíƒœì—ì„œ íŒ” ì›€ì§ì´ê¸°", "type": "Step Arm Movement"},
                    {"stage": 2, "name": "Step ë°˜ëŒ€ ìƒíƒœì—ì„œ íŒ” ì›€ì§ì´ê¸°", "type": "Opposite Step Arm Movement"},
                    {"stage": 3, "name": "Step ë³€í˜• ë™ì‘", "type": "Step Variation Movement"}
                ]
            },
            4: {
                "name": "ìŠ¤ë…¸ë¹„ 4",
                "stages": [
                    {"stage": 1, "name": "ì™¼íŒ” ìˆ˜í‰, ì˜¤ë¥¸íŒ” ì•ìœ¼ë¡œ", "type": "Left Horizontal Right Forward"},
                    {"stage": 2, "name": "ì˜¤ë¥¸íŒ” ìˆ˜í‰, ì™¼íŒ” ì•ìœ¼ë¡œ", "type": "Right Horizontal Left Forward"},
                    {"stage": 3, "name": "ì™¼íŒ” ìˆ˜í‰, ì˜¤ë¥¸íŒ” ì•„ë˜ë¡œ", "type": "Left Horizontal Right Down"},
                    {"stage": 4, "name": "ì˜¤ë¥¸íŒ” ìˆ˜í‰, ì™¼íŒ” ì•„ë˜ë¡œ", "type": "Right Horizontal Left Down"}
                ]
            },
            5: {
                "name": "ìŠ¤ë…¸ë¹„ 5",
                "stages": [
                    {"stage": 1, "name": "ë°œ ì›€ì§ì„ ë³µí•© ë™ì‘", "type": "Complex Foot Movement"},
                    {"stage": 2, "name": "ë°œ ì›€ì§ì„ ë³€í˜• ë™ì‘", "type": "Varied Foot Movement"},
                    {"stage": 3, "name": "ë°œ ì›€ì§ì„ ì‘ìš© ë™ì‘", "type": "Advanced Foot Movement"}
                ]
            },
            6: {
                "name": "ìŠ¤ë…¸ë¹„ 6",
                "stages": [
                    {"stage": 1, "name": "ë‹¤ë¦¬ ì•ìœ¼ë¡œ ë»—ê¸°", "type": "Forward Leg Extension"},
                    {"stage": 2, "name": "ë‹¤ë¦¬ ì˜†ìœ¼ë¡œ ë²Œë¦¬ê¸°", "type": "Side Leg Extension"},
                    {"stage": 3, "name": "ë‹¤ë¦¬ ëŒ€ê°ì„  ì•ìœ¼ë¡œ", "type": "Diagonal Leg Extension"}
                ]
            },
            7: {
                "name": "ìŠ¤ë…¸ë¹„ 7",
                "stages": [
                    {"stage": 1, "name": "ë³µí•© ë™ì‘ 1", "type": "Complex Movement 1"},
                    {"stage": 2, "name": "ë³µí•© ë™ì‘ 2", "type": "Complex Movement 2"},
                    {"stage": 3, "name": "ë³µí•© ë™ì‘ 3", "type": "Complex Movement 3"}
                ]
            },
            8: {
                "name": "ìŠ¤ë…¸ë¹„ 8",
                "stages": [
                    {"stage": 1, "name": "í•œìª½ ë‹¤ë¦¬ ì•, ë‹¤ë¥¸ ë‹¤ë¦¬ ìœ„ë¡œ", "type": "One Leg Forward Other Up"},
                    {"stage": 2, "name": "í•œìª½ ë‹¤ë¦¬ ì˜†, ë‹¤ë¥¸ ë‹¤ë¦¬ ìœ„ë¡œ", "type": "One Leg Side Other Up"},
                    {"stage": 3, "name": "ì •ìì„¸ì—ì„œ ë‹¤ë¦¬ ì˜¬ë¦¬ê¸°", "type": "Standing Leg Lift"}
                ]
            },
            9: {
                "name": "ìŠ¤ë…¸ë¹„ 9",
                "stages": [
                    {"stage": 1, "name": "ë³µí•© ë™ì‘ ì¡°í•© 1", "type": "Combined Movement 1"},
                    {"stage": 2, "name": "ë³µí•© ë™ì‘ ì¡°í•© 2", "type": "Combined Movement 2"},
                    {"stage": 3, "name": "ë³µí•© ë™ì‘ ì¡°í•© 3", "type": "Combined Movement 3"}
                ]
            },
            10: {
                "name": "ìŠ¤ë…¸ë¹„ 10",
                "stages": [
                    {"stage": 1, "name": "ì•ˆìª½ ë³µí•© ë™ì‘", "type": "Inner Combined Movement"},
                    {"stage": 2, "name": "ë°”ê¹¥ìª½ ë³µí•© ë™ì‘", "type": "Outer Combined Movement"},
                    {"stage": 3, "name": "ëŒ€ê°ì„  ë³µí•© ë™ì‘", "type": "Diagonal Combined Movement"}
                ]
            },
            11: {
                "name": "ìŠ¤ë…¸ë¹„ 11",
                "stages": [
                    {"stage": 1, "name": "íŒ” ë²Œë¦¬ê¸° + ë¬´ë¦ ë°”ê¹¥ìª½", "type": "Arm Spread Knees Out"},
                    {"stage": 2, "name": "íŒ” ë°˜ëŒ€ + ë¬´ë¦ ì•ˆìª½", "type": "Arm Opposite Knees In"},
                    {"stage": 3, "name": "íŒ” ë‚´ë¦¬ê¸° + ë¬´ë¦ ë°”ê¹¥ìª½", "type": "Arm Down Knees Out"},
                    {"stage": 4, "name": "íŒ” ë°˜ëŒ€ ë‚´ë¦¬ê¸° + ë¬´ë¦ ì•ˆìª½", "type": "Arm Opposite Down Knees In"}
                ]
            },
            12: {
                "name": "ìŠ¤ë…¸ë¹„ 12",
                "stages": [
                    {"stage": 1, "name": "ì™¼ì†ìœ¼ë¡œ ì˜¤ë¥¸ìª½ ë¬´ë¦ í„°ì¹˜", "type": "Left Hand Touch Right Knee"},
                    {"stage": 2, "name": "ì˜¤ë¥¸ì†ìœ¼ë¡œ ì™¼ìª½ ë¬´ë¦ í„°ì¹˜", "type": "Right Hand Touch Left Knee"},
                    {"stage": 3, "name": "ì™¼ì†ìœ¼ë¡œ ì˜¤ë¥¸ìª½ ë°œë í„°ì¹˜", "type": "Left Hand Touch Right Toe"},
                    {"stage": 4, "name": "ì˜¤ë¥¸ì†ìœ¼ë¡œ ì™¼ìª½ ë°œë í„°ì¹˜", "type": "Right Hand Touch Left Toe"}
                ]
            }
        };

        // íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    allData = Array.isArray(data) ? data : [data];
                    processData();
                } catch (error) {
                    alert('íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        // ìŠ¤ë…¸ë¹„ ë²ˆí˜¸ ìë™ ê°ì§€
        function extractSnoobyNumber(data) {
            const patientInfo = data[0];
            const chapter = patientInfo.chapter || patientInfo.test_name || '';

            const match = chapter.match(/ìŠ¤[ëª¨ë…¸]ë¹„\s*(\d+)/);
            if (match) {
                return parseInt(match[1]);
            }
            return null;
        }

        // ìŠ¤í…Œì´ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getStageInfo(snoobyNum, stageNum) {
            if (!snoobyNum || !SNOOBY_STAGES[snoobyNum]) return null;

            const snoobyData = SNOOBY_STAGES[snoobyNum];
            const stageData = snoobyData.stages.find(s => s.stage === stageNum);

            if (stageData) {
                return {
                    name: stageData.name,
                    type: stageData.type,
                    snoobyName: snoobyData.name
                };
            }
            return null;
        }

        function processData() {
            if (allData.length === 0) return;

            // í™˜ì ì •ë³´ í‘œì‹œ
            const first = allData[0];
            const snoobyNum = extractSnoobyNumber(allData);

            document.getElementById('patient-name').textContent = first.name || '-';

            // ìŠ¤ë…¸ë¹„ ì •ë³´ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            let gameName = first.chapter || first.test_name || '-';
            if (snoobyNum && SNOOBY_STAGES[snoobyNum]) {
                gameName = `${SNOOBY_STAGES[snoobyNum].name} (${gameName})`;
            }
            document.getElementById('game-name').textContent = gameName;

            document.getElementById('total-stages').textContent = allData.length + 'ê°œ';
            document.getElementById('patient-info').style.display = 'block';

            // íƒ­ í‘œì‹œ
            document.getElementById('tab-navigation').style.display = 'flex';
            document.getElementById('tab-content').style.display = 'block';

            // ì „ì²´ ë¹„êµ íƒ­ ë Œë”ë§
            renderOverviewTab();
        }

        function parseArrayField(field) {
            if (Array.isArray(field)) return field;
            if (typeof field === 'string') {
                try {
                    // ë¨¼ì € ë‹¨ì¼ íŒŒì‹± ì‹œë„
                    let parsed = JSON.parse(field);
                    // íŒŒì‹± ê²°ê³¼ê°€ ë¬¸ìì—´ì´ë©´ ë‹¤ì‹œ íŒŒì‹± (ì´ì¤‘ ì¸ì½”ë”©)
                    if (typeof parsed === 'string') {
                        parsed = JSON.parse(parsed);
                    }
                    // ê²°ê³¼ê°€ ë°°ì—´ì¸ì§€ í™•ì¸
                    if (Array.isArray(parsed)) {
                        return parsed;
                    }
                    return [];
                } catch (e) {
                    console.error('íŒŒì‹± ì˜¤ë¥˜:', e, 'field:', field);
                    return [];
                }
            }
            return [];
        }

        // ì¤€ë¹„/ë§ˆë¬´ë¦¬ ìì„¸ êµ¬ê°„ ì œê±° í•¨ìˆ˜
        function trimPrepAndFinish(dataArray, threshold = 150) {
            if (dataArray.length === 0) return dataArray;

            // ì•ì—ì„œë¶€í„° threshold ì´ìƒì¸ ì²« ë²ˆì§¸ ì¸ë±ìŠ¤ ì°¾ê¸°
            let startIdx = 0;
            for (let i = 0; i < Math.min(5, dataArray.length); i++) {
                if (Math.abs(dataArray[i]) > threshold) {
                    startIdx = i + 1; // ì´ìƒì¹˜ ë‹¤ìŒë¶€í„° ì‹œì‘
                    break;
                }
            }

            // ë’¤ì—ì„œë¶€í„° threshold ì´ìƒì¸ ë§ˆì§€ë§‰ ì¸ë±ìŠ¤ ì°¾ê¸°
            let endIdx = dataArray.length;
            for (let i = dataArray.length - 1; i >= Math.max(0, dataArray.length - 5); i--) {
                if (Math.abs(dataArray[i]) > threshold) {
                    endIdx = i; // ì´ìƒì¹˜ ì „ê¹Œì§€
                    break;
                }
            }

            // ìœ íš¨í•œ êµ¬ê°„ë§Œ ë°˜í™˜
            if (startIdx < endIdx) {
                return dataArray.slice(startIdx, endIdx);
            }

            return dataArray;
        }

        function calculateMedicalScores(moveErrs, balanceErrs, speedErrs) {
            // ë°°ì—´ ê²€ì¦
            if (!Array.isArray(moveErrs) || moveErrs.length === 0) {
                console.error('moveErrsê°€ ìœ íš¨í•œ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:', moveErrs);
                return { movement: 0, balance: 0, speedConsistency: 0, focus: 0, learning: 0, strength: 0 };
            }
            if (!Array.isArray(balanceErrs) || balanceErrs.length === 0) {
                console.error('balanceErrsê°€ ìœ íš¨í•œ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:', balanceErrs);
                return { movement: 0, balance: 0, speedConsistency: 0, focus: 0, learning: 0, strength: 0 };
            }
            if (!Array.isArray(speedErrs) || speedErrs.length === 0) {
                console.error('speedErrsê°€ ìœ íš¨í•œ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:', speedErrs);
                return { movement: 0, balance: 0, speedConsistency: 0, focus: 0, learning: 0, strength: 0 };
            }

            const moveAvg = moveErrs.reduce((a,b) => a+b, 0) / moveErrs.length;
            const movementScore = Math.max(0, Math.min(100, 100 - moveAvg));

            const balanceAbsAvg = balanceErrs.reduce((sum, val) => sum + Math.abs(val), 0) / balanceErrs.length;
            const balanceScore = Math.max(0, Math.min(100, 100 - balanceAbsAvg));

            const speedAvg = speedErrs.reduce((a,b) => a+b, 0) / speedErrs.length;
            const speedVariance = speedErrs.reduce((sum, val) => sum + Math.pow(val - speedAvg, 2), 0) / speedErrs.length;
            const speedStdDev = Math.sqrt(speedVariance);
            const speedConsistencyScore = Math.max(0, Math.min(100, 100 - speedStdDev));

            let consecutiveFails = 0;
            let maxConsecutiveFails = 0;
            moveErrs.forEach(err => {
                if (err > 50) {
                    consecutiveFails++;
                    maxConsecutiveFails = Math.max(maxConsecutiveFails, consecutiveFails);
                } else {
                    consecutiveFails = 0;
                }
            });
            const moveStdDev = Math.sqrt(moveErrs.reduce((sum, val) => sum + Math.pow(val - moveAvg, 2), 0) / moveErrs.length);
            const focusScore = Math.max(0, Math.min(100, 100 - (maxConsecutiveFails * 5 + moveStdDev * 0.5)));

            const half = Math.floor(moveErrs.length / 2);
            const firstAvg = moveErrs.slice(0, half).reduce((a,b) => a+b, 0) / half;
            const secondAvg = moveErrs.slice(half).reduce((a,b) => a+b, 0) / (moveErrs.length - half);
            const improvement = firstAvg - secondAvg;
            const learningScore = Math.max(0, Math.min(100, 100 + improvement * 2));

            const fatigue = secondAvg - firstAvg;
            const strengthScore = Math.max(0, Math.min(100, 100 - fatigue));

            return {
                movement: movementScore,
                balance: balanceScore,
                speedConsistency: speedConsistencyScore,
                focus: focusScore,
                learning: learningScore,
                strength: strengthScore
            };
        }

        function getGrade(score) {
            if (score >= 90) return { grade: 'S', color: 'text-green-600', bg: 'bg-green-50' };
            if (score >= 80) return { grade: 'A', color: 'text-blue-600', bg: 'bg-blue-50' };
            if (score >= 70) return { grade: 'B', color: 'text-yellow-600', bg: 'bg-yellow-50' };
            if (score >= 60) return { grade: 'C', color: 'text-orange-600', bg: 'bg-orange-50' };
            return { grade: 'D', color: 'text-red-600', bg: 'bg-red-50' };
        }

        function renderStagesInfo() {
            const snoobyNum = extractSnoobyNumber(allData);

            if (!snoobyNum || !SNOOBY_STAGES[snoobyNum]) {
                document.getElementById('snooby-stages-info').style.display = 'none';
                return;
            }

            const snoobyData = SNOOBY_STAGES[snoobyNum];
            const stagesInfoContent = document.getElementById('stages-info-content');

            let html = '';
            snoobyData.stages.forEach(stageData => {
                html += `
                    <div class="bg-gradient-to-br from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                ${stageData.stage}
                            </div>
                            <div class="font-bold text-gray-800">Stage ${stageData.stage}</div>
                        </div>
                        <div class="text-sm font-semibold text-purple-900 mb-1">${stageData.name}</div>
                        <div class="text-xs text-gray-600">${stageData.type}</div>
                    </div>
                `;
            });

            stagesInfoContent.innerHTML = html;
            document.getElementById('snooby-stages-info').style.display = 'block';
        }

        function renderOverviewTab() {
            // ìŠ¤í…Œì´ì§€ ì •ë³´ í‘œì‹œ
            renderStagesInfo();

            // ëª¨ë“  ë ˆì½”ë“œì˜ ì ìˆ˜ ê³„ì‚°
            const allScores = allData.map((record, idx) => {
                console.log(`ë ˆì½”ë“œ ${idx}:`, record);
                console.log(`move_err íƒ€ì…:`, typeof record.move_err, record.move_err);

                // ë°ì´í„° íŒŒì‹± ë° ì¤€ë¹„/ë§ˆë¬´ë¦¬ êµ¬ê°„ ì œê±°
                let moveErrs = parseArrayField(record.move_err);
                let balanceErrs = parseArrayField(record.balance_err);
                let speedErrs = parseArrayField(record.speed_err);

                console.log(`íŒŒì‹± ì „ moveErrs ê¸¸ì´:`, moveErrs.length);

                // ì¤€ë¹„/ë§ˆë¬´ë¦¬ ìì„¸ ì œê±° (threshold = 150)
                moveErrs = trimPrepAndFinish(moveErrs, 150);
                balanceErrs = trimPrepAndFinish(balanceErrs, 150);
                speedErrs = trimPrepAndFinish(speedErrs, 150);

                console.log(`íŠ¸ë¦¬ë° í›„ moveErrs ê¸¸ì´:`, moveErrs.length);
                console.log(`íŒŒì‹±ëœ moveErrs:`, moveErrs);
                console.log(`íŒŒì‹±ëœ balanceErrs:`, balanceErrs);
                console.log(`íŒŒì‹±ëœ speedErrs:`, speedErrs);

                const scores = calculateMedicalScores(moveErrs, balanceErrs, speedErrs);
                return {
                    stage: record.stage,
                    bpm: record.bpm,
                    scores: scores,
                    label: `Stage ${record.stage} (BPM ${record.bpm})`
                };
            });

            // ë ˆì´ë” ì°¨íŠ¸ ë Œë”ë§ (ì „ì²´ í‰ê· )
            renderOverviewRadarChart(allScores);

            // ë¹„êµ í…Œì´ë¸” ë Œë”ë§ (í‰ê· )
            renderComparisonTable(allScores);

            // í‰ê·  ì ìˆ˜ ì—…ë°ì´íŠ¸
            const avgScore = allScores.reduce((sum, s) => {
                const avg = (s.scores.movement + s.scores.balance + s.scores.speedConsistency +
                             s.scores.focus + s.scores.learning + s.scores.strength) / 6;
                return sum + avg;
            }, 0) / allScores.length;
            document.getElementById('avg-score').textContent = avgScore.toFixed(0) + 'ì ';
        }

        function renderOverviewRadarChart(allScores) {
            const ctx = document.getElementById('overviewRadarChart').getContext('2d');

            if (charts.overviewRadar) {
                charts.overviewRadar.destroy();
            }

            // ì „ì²´ í‰ê·  ê³„ì‚°
            const avgScores = {
                movement: 0,
                balance: 0,
                speedConsistency: 0,
                focus: 0,
                learning: 0,
                strength: 0
            };

            allScores.forEach(scoreData => {
                avgScores.movement += scoreData.scores.movement;
                avgScores.balance += scoreData.scores.balance;
                avgScores.speedConsistency += scoreData.scores.speedConsistency;
                avgScores.focus += scoreData.scores.focus;
                avgScores.learning += scoreData.scores.learning;
                avgScores.strength += scoreData.scores.strength;
            });

            const count = allScores.length;
            avgScores.movement /= count;
            avgScores.balance /= count;
            avgScores.speedConsistency /= count;
            avgScores.focus /= count;
            avgScores.learning /= count;
            avgScores.strength /= count;

            const datasets = [{
                label: 'ì „ì²´ í‰ê· ',
                data: [
                    avgScores.movement,
                    avgScores.balance,
                    avgScores.speedConsistency,
                    avgScores.focus,
                    avgScores.learning,
                    avgScores.strength
                ],
                fill: true,
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderColor: 'rgb(59, 130, 246)',
                pointBackgroundColor: 'rgb(59, 130, 246)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(59, 130, 246)',
                pointRadius: 5,
                pointHoverRadius: 7,
                borderWidth: 3
            }];

            charts.overviewRadar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ë™ì‘ ì •í™•ë„', 'ê· í˜• ëŠ¥ë ¥', 'ì†ë„ ì¼ê´€ì„±', 'ì§‘ì¤‘ë ¥', 'í•™ìŠµë ¥', 'ê·¼ë ¥/ì§€êµ¬ë ¥'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { display: true, color: 'rgba(0, 0, 0, 0.1)' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            pointLabels: { font: { size: 13, weight: 'bold' } },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: { stepSize: 20, callback: value => value + 'ì ' }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.r.toFixed(1) + 'ì ';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderComparisonTable(allScores) {
            const tbody = document.getElementById('comparison-tbody');

            // í‰ê°€ ì˜ì—­ ì •ì˜
            const areas = [
                { key: 'movement', name: 'ğŸ¯ ë™ì‘ ì •í™•ë„', desc: 'ë™ì‘ì˜ ì •í™•ì„±ê³¼ ì¼ì¹˜ë„' },
                { key: 'balance', name: 'âš–ï¸ ê· í˜• ëŠ¥ë ¥', desc: 'ì¢Œìš° ê· í˜•ê³¼ ì•ˆì •ì„±' },
                { key: 'speedConsistency', name: 'â±ï¸ ì†ë„ ì¼ê´€ì„±', desc: 'BPM ìœ ì§€ ëŠ¥ë ¥' },
                { key: 'focus', name: 'ğŸ¯ ì§‘ì¤‘ë ¥', desc: 'ì§€ì†ì ì¸ ì§‘ì¤‘ ìœ ì§€' },
                { key: 'learning', name: 'ğŸ“š í•™ìŠµë ¥', desc: 'ë™ì‘ ê°œì„  ì†ë„' },
                { key: 'strength', name: 'ğŸ’ª ê·¼ë ¥/ì§€êµ¬ë ¥', desc: 'ë™ì‘ ì§€ì† ëŠ¥ë ¥' }
            ];

            // ì˜ì—­ë³„ í‰ê·  ê³„ì‚°
            const avgScores = {};
            areas.forEach(area => {
                const sum = allScores.reduce((total, scoreData) => total + scoreData.scores[area.key], 0);
                avgScores[area.key] = sum / allScores.length;
            });

            // í…Œì´ë¸” ë°”ë”” ìƒì„±
            tbody.innerHTML = '';
            areas.forEach(area => {
                const score = avgScores[area.key];
                const gradeInfo = getGrade(score);
                const row = `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="border border-gray-300 p-4">
                            <div class="font-bold text-gray-800">${area.name}</div>
                            <div class="text-xs text-gray-500 mt-1">${area.desc}</div>
                        </td>
                        <td class="border border-gray-300 p-4 text-center ${gradeInfo.bg}">
                            <span class="font-bold text-2xl text-gray-800">${score.toFixed(1)}</span>
                            <span class="text-sm text-gray-500">ì </span>
                        </td>
                        <td class="border border-gray-300 p-4 text-center ${gradeInfo.bg}">
                            <span class="font-bold text-xl ${gradeInfo.color}">${gradeInfo.grade}</span>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }


        // íƒ­ ì „í™˜
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const targetTab = this.dataset.tab;

                // ëª¨ë“  íƒ­ ë²„íŠ¼ê³¼ íŒ¨ë„ ë¹„í™œì„±í™”
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');

                // ì„ íƒëœ íƒ­ í™œì„±í™”
                this.classList.add('active');
                document.getElementById(targetTab + '-tab').style.display = 'block';

                // Stage íƒ­ì´ë©´ ë°ì´í„° ë¡œë“œ
                if (targetTab !== 'overview') {
                    const stageNum = parseInt(targetTab.replace('stage', ''));
                    renderStageDetailWithBPMs(stageNum);
                }
            });
        });

        // BPM ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸
        document.querySelectorAll('.stage-bpm-filter').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const stage = parseInt(this.dataset.stage);
                renderStageDetailWithBPMs(stage);
            });
        });

        function renderStageDetailWithBPMs(stage) {
            // ì„ íƒëœ BPM ì²´í¬ë°•ìŠ¤ í™•ì¸
            const selectedBPMs = [];
            document.querySelectorAll(`.stage-bpm-filter[data-stage="${stage}"]:checked`).forEach(checkbox => {
                selectedBPMs.push(parseInt(checkbox.dataset.bpm));
            });

            if (selectedBPMs.length === 0) {
                document.getElementById(`stage${stage}-content`).innerHTML = '<p class="text-gray-500 text-center py-8">BPMì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            // ì„ íƒëœ BPMì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const stageDataList = selectedBPMs.map(bpm => {
                const data = allData.find(d => d.stage === stage && d.bpm === bpm);
                return data ? { bpm, data } : null;
            }).filter(item => item !== null);

            if (stageDataList.length === 0) {
                document.getElementById(`stage${stage}-content`).innerHTML = '<p class="text-gray-500 text-center py-8">í•´ë‹¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ì¤‘ì²© ê·¸ë˜í”„ ë Œë”ë§
            renderStageDetailOverlay(stage, stageDataList);
        }

        function renderStageDetailOverlay(stage, stageDataList) {
            const container = document.getElementById(`stage${stage}-content`);

            // ì²« ë²ˆì§¸ ë°ì´í„°ë¡œ ê¸°ë³¸ ì •ë³´ í‘œì‹œ
            const firstData = stageDataList[0].data;
            const firstMoveErrs = parseArrayField(firstData.move_err);

            // ìŠ¤ë…¸ë¹„ ë²ˆí˜¸ ê°ì§€ ë° ìŠ¤í…Œì´ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const snoobyNum = extractSnoobyNumber(allData);
            const stageInfo = getStageInfo(snoobyNum, stage);

            // ìŠ¤í…Œì´ì§€ ì„¤ëª… HTML ìƒì„±
            let stageDescriptionHtml = '';
            if (stageInfo) {
                stageDescriptionHtml = `
                    <div class="col-span-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg shadow border-l-4 border-purple-500">
                        <div class="text-xs text-purple-600 font-semibold mb-1">ğŸ¯ Stage ${stage} ë™ì‘ ì„¤ëª…</div>
                        <div class="text-lg font-bold text-gray-800">${stageInfo.name}</div>
                        <div class="text-sm text-gray-600 mt-1">${stageInfo.type}</div>
                    </div>
                `;
            }

            container.innerHTML = `
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>
                    <div class="grid grid-cols-4 gap-4">
                        ${stageDescriptionHtml}
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-xs text-gray-500 mb-1">ë¹„êµ ë°ì´í„°</div>
                            <div class="text-2xl font-bold text-blue-600">${stageDataList.length}ê°œ</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-xs text-gray-500 mb-1">ì„ íƒëœ BPM</div>
                            <div class="text-lg font-bold text-blue-600">${stageDataList.map(d => d.bpm).join(', ')}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-xs text-gray-500 mb-1">ê²Œì„ ì‹œê°„</div>
                            <div class="text-2xl font-bold text-blue-600">${firstData.gametime ? firstData.gametime.split(' ')[1] : '-'}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-xs text-gray-500 mb-1">ë‚œì´ë„</div>
                            <div class="text-2xl font-bold text-blue-600">${firstData.status || '-'}</div>
                        </div>
                    </div>
                </div>

                <!-- ë™ì‘ ì˜¤ì°¨ ê·¸ë˜í”„ -->
                <div class="bg-white rounded-2xl p-6 shadow-2xl mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">ğŸ¯ ë™ì‘ ì˜¤ì°¨ (move_err)</h2>
                            <p class="text-sm text-gray-500">ë™ì‘ì˜ ì •í™•ë„ - ë‚®ì„ìˆ˜ë¡ ì •í™•í•œ ë™ì‘</p>
                        </div>
                        <div class="flex gap-4">
                            <div class="text-center">
                                <div class="text-xs text-gray-500">í‰ê·  ì˜¤ì°¨</div>
                                <div class="text-xl font-bold text-red-600" id="stage${stage}-move-avg">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500">ìµœëŒ€ ì˜¤ì°¨</div>
                                <div class="text-xl font-bold text-orange-600" id="stage${stage}-move-max">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="stage${stage}MoveChart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-3 gap-2 text-xs">
                        <div class="flex items-center gap-2 p-2 rounded bg-green-50">
                            <div class="w-4 h-4 bg-green-500 rounded"></div>
                            <span>ìš°ìˆ˜ (ì˜¤ì°¨ < 30)</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded bg-yellow-50">
                            <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                            <span>ë³´í†µ (30 â‰¤ ì˜¤ì°¨ < 60)</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded bg-red-50">
                            <div class="w-4 h-4 bg-red-500 rounded"></div>
                            <span>ê°œì„  í•„ìš” (ì˜¤ì°¨ â‰¥ 60)</span>
                        </div>
                    </div>
                    <div class="mt-4 bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <h3 class="font-semibold text-gray-800 mb-2">ğŸ’¡ í•´ì„ ê°€ì´ë“œ</h3>
                        <div class="text-sm text-gray-700 space-y-1" id="stage${stage}-move-comment">
                            <p>â€¢ BPMë³„ë¡œ ë™ì‘ ì˜¤ì°¨ íŒ¨í„´ì„ ë¹„êµí•˜ì„¸ìš”</p>
                            <p>â€¢ ì´ˆë¡ìƒ‰ ì˜ì—­ì— ë¨¸ë¬¼ìˆ˜ë¡ ì •í™•í•œ ë™ì‘ì…ë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>

                <!-- ê· í˜• ì˜¤ì°¨ ê·¸ë˜í”„ -->
                <div class="bg-white rounded-2xl p-6 shadow-2xl mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">âš–ï¸ ê· í˜• ì˜¤ì°¨ (balance_err)</h2>
                            <p class="text-sm text-gray-500">ì¢Œìš° ê· í˜• - ëª¸ì˜ ì¤‘ì‹¬ì´ í”ë“¤ë¦¬ëŠ” ì •ë„</p>
                        </div>
                        <div class="flex gap-4">
                            <div class="text-center">
                                <div class="text-xs text-gray-500">í‰ê·  ì˜¤ì°¨</div>
                                <div class="text-xl font-bold text-purple-600" id="stage${stage}-balance-avg">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500">í‘œì¤€í¸ì°¨</div>
                                <div class="text-xl font-bold text-indigo-600" id="stage${stage}-balance-stddev">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="stage${stage}BalanceChart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-3 gap-2 text-xs">
                        <div class="flex items-center gap-2 p-2 rounded bg-green-50">
                            <div class="w-4 h-4 bg-green-500 rounded"></div>
                            <span>ì•ˆì • (ì˜¤ì°¨ < 20)</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded bg-yellow-50">
                            <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                            <span>ì•½ê°„ í”ë“¤ë¦¼ (20 â‰¤ ì˜¤ì°¨ < 40)</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded bg-red-50">
                            <div class="w-4 h-4 bg-red-500 rounded"></div>
                            <span>ë¶ˆì•ˆì • (ì˜¤ì°¨ â‰¥ 40)</span>
                        </div>
                    </div>
                    <div class="mt-4 bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                        <h3 class="font-semibold text-gray-800 mb-2">ğŸ’¡ í•´ì„ ê°€ì´ë“œ</h3>
                        <div class="text-sm text-gray-700 space-y-1" id="stage${stage}-balance-comment">
                            <p>â€¢ 0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì™„ë²½í•œ ì¢Œìš° ê· í˜•ì…ë‹ˆë‹¤</p>
                            <p>â€¢ ì´ˆë¡ìƒ‰ ì˜ì—­ ë‚´ì—ì„œ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                </div>

                <!-- ì†ë„ ì˜¤ì°¨ ê·¸ë˜í”„ -->
                <div class="bg-white rounded-2xl p-6 shadow-2xl mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">â±ï¸ ì†ë„ ì˜¤ì°¨ (speed_err)</h2>
                            <p class="text-sm text-gray-500">ë™ì‘ ì†ë„ì˜ ì¼ê´€ì„± - BPMì— ë§ì¶° í•˜ëŠ”ì§€ í‰ê°€</p>
                        </div>
                        <div class="flex gap-4">
                            <div class="text-center">
                                <div class="text-xs text-gray-500">í‰ê·  ì˜¤ì°¨</div>
                                <div class="text-xl font-bold text-blue-600" id="stage${stage}-speed-avg">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500">í‘œì¤€í¸ì°¨</div>
                                <div class="text-xl font-bold text-cyan-600" id="stage${stage}-speed-stddev">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="stage${stage}SpeedChart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-3 gap-2 text-xs">
                        <div class="flex items-center gap-2 p-2 rounded bg-green-50">
                            <div class="w-4 h-4 bg-green-500 rounded"></div>
                            <span>ë¦¬ë“¬ê° ìš°ìˆ˜ (ì˜¤ì°¨ < 20)</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded bg-yellow-50">
                            <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                            <span>ë³´í†µ (20 â‰¤ ì˜¤ì°¨ < 40)</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded bg-red-50">
                            <div class="w-4 h-4 bg-red-500 rounded"></div>
                            <span>ë¶ˆê·œì¹™ (ì˜¤ì°¨ â‰¥ 40)</span>
                        </div>
                    </div>
                    <div class="mt-4 bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
                        <h3 class="font-semibold text-gray-800 mb-2">ğŸ’¡ í•´ì„ ê°€ì´ë“œ</h3>
                        <div class="text-sm text-gray-700 space-y-1" id="stage${stage}-speed-comment">
                            <p>â€¢ ì¼ì •í•œ ì†ë„ë¥¼ ìœ ì§€í• ìˆ˜ë¡ ì¸ì§€-ìš´ë™ í˜‘ì‘ë ¥ì´ ì¢‹ìŠµë‹ˆë‹¤</p>
                            <p>â€¢ BPMë³„ ì†ë„ íŒ¨í„´ ì°¨ì´ë¥¼ ë¹„êµí•´ë³´ì„¸ìš”</p>
                        </div>
                    </div>
                </div>
            `;

            // í†µê³„ ë°ì´í„° ê³„ì‚° ë° í‘œì‹œ
            calculateAndDisplayStats(stage, stageDataList);

            // ì¤‘ì²© ì‹œê³„ì—´ ê·¸ë˜í”„ ìƒì„±
            createOverlayTimeSeriesCharts(stage, stageDataList);
        }

        function calculateAndDisplayStats(stage, stageDataList) {
            // ê° BPM ë°ì´í„°ì˜ í†µê³„ ê³„ì‚°
            const allMoveErrs = [];
            const allBalanceErrs = [];
            const allSpeedErrs = [];

            stageDataList.forEach(item => {
                let moveErrs = parseArrayField(item.data.move_err);
                let balanceErrs = parseArrayField(item.data.balance_err);
                let speedErrs = parseArrayField(item.data.speed_err);

                // ì¤€ë¹„/ë§ˆë¬´ë¦¬ ìì„¸ ì œê±°
                moveErrs = trimPrepAndFinish(moveErrs, 150);
                balanceErrs = trimPrepAndFinish(balanceErrs, 150);
                speedErrs = trimPrepAndFinish(speedErrs, 150);

                allMoveErrs.push(...moveErrs);
                allBalanceErrs.push(...balanceErrs);
                allSpeedErrs.push(...speedErrs);
            });

            // ë™ì‘ ì˜¤ì°¨ í†µê³„
            const moveAvg = allMoveErrs.reduce((a, b) => a + b, 0) / allMoveErrs.length;
            const moveMax = Math.max(...allMoveErrs);
            document.getElementById(`stage${stage}-move-avg`).textContent = moveAvg.toFixed(1);
            document.getElementById(`stage${stage}-move-max`).textContent = moveMax.toFixed(1);

            // ê· í˜• ì˜¤ì°¨ í†µê³„
            const balanceAvg = allBalanceErrs.reduce((a, b) => a + b, 0) / allBalanceErrs.length;
            const balanceAbsAvg = allBalanceErrs.reduce((sum, val) => sum + Math.abs(val), 0) / allBalanceErrs.length;
            const balanceVariance = allBalanceErrs.reduce((sum, val) => sum + Math.pow(val - balanceAvg, 2), 0) / allBalanceErrs.length;
            const balanceStdDev = Math.sqrt(balanceVariance);
            document.getElementById(`stage${stage}-balance-avg`).textContent = balanceAbsAvg.toFixed(1);
            document.getElementById(`stage${stage}-balance-stddev`).textContent = balanceStdDev.toFixed(1);

            // ì†ë„ ì˜¤ì°¨ í†µê³„
            const speedAvg = allSpeedErrs.reduce((a, b) => a + b, 0) / allSpeedErrs.length;
            const speedVariance = allSpeedErrs.reduce((sum, val) => sum + Math.pow(val - speedAvg, 2), 0) / allSpeedErrs.length;
            const speedStdDev = Math.sqrt(speedVariance);
            document.getElementById(`stage${stage}-speed-avg`).textContent = speedAvg.toFixed(1);
            document.getElementById(`stage${stage}-speed-stddev`).textContent = speedStdDev.toFixed(1);
        }

        function renderStageDetail(stage, data) {
            const container = document.getElementById(`stage${stage}-content`);

            const moveErrs = parseArrayField(data.move_err);
            const balanceErrs = parseArrayField(data.balance_err);
            const speedErrs = parseArrayField(data.speed_err);
            const scores = calculateMedicalScores(moveErrs, balanceErrs, speedErrs);

            container.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">ê¸°ë³¸ ì •ë³´</h3>
                    <div class="grid grid-cols-4 gap-4">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-500">BPM</div>
                            <div class="text-2xl font-bold text-gray-800">${data.bpm}</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-500">í”„ë ˆì„ ìˆ˜</div>
                            <div class="text-2xl font-bold text-gray-800">${moveErrs.length}ê°œ</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-500">ê²Œì„ ì‹œê°„</div>
                            <div class="text-2xl font-bold text-gray-800">${data.gametime ? data.gametime.split(' ')[1] : '-'}</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-500">ë‚œì´ë„</div>
                            <div class="text-2xl font-bold text-gray-800">${data.status || '-'}</div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">ğŸ¥ ì˜ë£Œ í‰ê°€ ë ˆì´ë” ì°¨íŠ¸</h3>
                    <div class="small-chart">
                        <canvas id="stage${stage}RadarChart"></canvas>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">ğŸ“Š 6ê°œ ì˜ì—­ ì ìˆ˜</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="text-xs text-gray-500 mb-1">ë™ì‘ ì •í™•ë„</div>
                            <div class="text-2xl font-bold text-blue-600">${scores.movement.toFixed(0)}</div>
                            <div class="text-xs font-semibold ${getGrade(scores.movement).color}">${getGrade(scores.movement).grade}</div>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="text-xs text-gray-500 mb-1">ê· í˜• ëŠ¥ë ¥</div>
                            <div class="text-2xl font-bold text-purple-600">${scores.balance.toFixed(0)}</div>
                            <div class="text-xs font-semibold ${getGrade(scores.balance).color}">${getGrade(scores.balance).grade}</div>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                            <div class="text-xs text-gray-500 mb-1">ì†ë„ ì¼ê´€ì„±</div>
                            <div class="text-2xl font-bold text-green-600">${scores.speedConsistency.toFixed(0)}</div>
                            <div class="text-xs font-semibold ${getGrade(scores.speedConsistency).color}">${getGrade(scores.speedConsistency).grade}</div>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div class="text-xs text-gray-500 mb-1">ì§‘ì¤‘ë ¥</div>
                            <div class="text-2xl font-bold text-yellow-600">${scores.focus.toFixed(0)}</div>
                            <div class="text-xs font-semibold ${getGrade(scores.focus).color}">${getGrade(scores.focus).grade}</div>
                        </div>
                        <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                            <div class="text-xs text-gray-500 mb-1">í•™ìŠµë ¥</div>
                            <div class="text-2xl font-bold text-indigo-600">${scores.learning.toFixed(0)}</div>
                            <div class="text-xs font-semibold ${getGrade(scores.learning).color}">${getGrade(scores.learning).grade}</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                            <div class="text-xs text-gray-500 mb-1">ê·¼ë ¥/ì§€êµ¬ë ¥</div>
                            <div class="text-2xl font-bold text-red-600">${scores.strength.toFixed(0)}</div>
                            <div class="text-xs font-semibold ${getGrade(scores.strength).color}">${getGrade(scores.strength).grade}</div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">ğŸ“ˆ ì‹œê³„ì—´ ë¶„ì„ (3ê°œ ê·¸ë˜í”„)</h3>

                    <!-- ë™ì‘ ì˜¤ì°¨ ê·¸ë˜í”„ -->
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-gray-600 mb-2">ğŸ¯ ë™ì‘ ì˜¤ì°¨ (move_err)</h4>
                        <div class="chart-container">
                            <canvas id="stage${stage}MoveChart"></canvas>
                        </div>
                    </div>

                    <!-- ê· í˜• ì˜¤ì°¨ ê·¸ë˜í”„ -->
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-gray-600 mb-2">âš–ï¸ ê· í˜• ì˜¤ì°¨ (balance_err)</h4>
                        <div class="chart-container">
                            <canvas id="stage${stage}BalanceChart"></canvas>
                        </div>
                    </div>

                    <!-- ì†ë„ ì˜¤ì°¨ ê·¸ë˜í”„ -->
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-gray-600 mb-2">â±ï¸ ì†ë„ ì˜¤ì°¨ (speed_err)</h4>
                        <div class="chart-container">
                            <canvas id="stage${stage}SpeedChart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            // ë ˆì´ë” ì°¨íŠ¸ ë Œë”ë§
            const ctx = document.getElementById(`stage${stage}RadarChart`).getContext('2d');
            if (charts[`stage${stage}Radar`]) {
                charts[`stage${stage}Radar`].destroy();
            }

            charts[`stage${stage}Radar`] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ë™ì‘ ì •í™•ë„', 'ê· í˜• ëŠ¥ë ¥', 'ì†ë„ ì¼ê´€ì„±', 'ì§‘ì¤‘ë ¥', 'í•™ìŠµë ¥', 'ê·¼ë ¥/ì§€êµ¬ë ¥'],
                    datasets: [{
                        label: `Stage ${stage} (BPM ${data.bpm})`,
                        data: [scores.movement, scores.balance, scores.speedConsistency, scores.focus, scores.learning, scores.strength],
                        fill: true,
                        backgroundColor: 'rgba(139, 92, 246, 0.2)',
                        borderColor: 'rgb(139, 92, 246)',
                        pointBackgroundColor: 'rgb(139, 92, 246)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(139, 92, 246)',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        borderWidth: 3
                    }, {
                        label: 'ì •ìƒ ë²”ìœ„ (80ì )',
                        data: [80, 80, 80, 80, 80, 80],
                        fill: true,
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { display: true, color: 'rgba(0, 0, 0, 0.1)' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            pointLabels: { font: { size: 12, weight: 'bold' } },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: { stepSize: 20, callback: value => value + 'ì ' }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'bottom' }
                    }
                }
            });

            // ì‹œê³„ì—´ ê·¸ë˜í”„ ìƒì„±
            createTimeSeriesCharts(stage, moveErrs, balanceErrs, speedErrs);
        }

        function createTimeSeriesCharts(stage, moveErrs, balanceErrs, speedErrs) {
            const MOVE_THRESHOLD = 50;
            const BALANCE_THRESHOLD = 40;
            const SPEED_THRESHOLD = 30;

            // í”„ë ˆì„ ë²ˆí˜¸ë¥¼ ì‹œê°„(ì´ˆ)ë¡œ ë³€í™˜ (30fps ê°€ì •)
            const fps = 30;
            const timeLabels = moveErrs.map((_, i) => (i / fps).toFixed(1));

            // 1. ë™ì‘ ì˜¤ì°¨ ê·¸ë˜í”„
            const ctx1 = document.getElementById(`stage${stage}MoveChart`).getContext('2d');
            if (charts[`stage${stage}Move`]) {
                charts[`stage${stage}Move`].destroy();
            }

            charts[`stage${stage}Move`] = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'ë™ì‘ ì˜¤ì°¨ (ë‚®ì„ìˆ˜ë¡ ì •í™•)',
                        data: moveErrs,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.3,
                        fill: true,
                        segment: {
                            borderColor: (ctx) => {
                                const value = moveErrs[ctx.p0DataIndex];
                                return value > MOVE_THRESHOLD ? 'rgb(239, 68, 68)' : 'rgb(59, 130, 246)';
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'ì‹œê°„ (ì´ˆ)', font: { weight: 'bold' } }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'ì˜¤ì°¨ ê°’', font: { weight: 'bold' } },
                            ticks: { callback: value => value.toFixed(0) }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        annotation: {
                            annotations: {
                                threshold: {
                                    type: 'line',
                                    yMin: MOVE_THRESHOLD,
                                    yMax: MOVE_THRESHOLD,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `ê²½ê³  ê¸°ì¤€ (${MOVE_THRESHOLD})`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        color: 'white'
                                    }
                                },
                                goodZone: {
                                    type: 'box',
                                    yMin: 0,
                                    yMax: MOVE_THRESHOLD,
                                    backgroundColor: 'rgba(34, 197, 94, 0.05)',
                                    borderWidth: 0
                                }
                            }
                        }
                    }
                }
            });

            // 2. ê· í˜• ì˜¤ì°¨ ê·¸ë˜í”„
            const ctx2 = document.getElementById(`stage${stage}BalanceChart`).getContext('2d');
            if (charts[`stage${stage}Balance`]) {
                charts[`stage${stage}Balance`].destroy();
            }

            charts[`stage${stage}Balance`] = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'ê· í˜• ì˜¤ì°¨ (0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì¢‹ìŒ)',
                        data: balanceErrs,
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.3,
                        fill: true,
                        segment: {
                            borderColor: (ctx) => {
                                const value = Math.abs(balanceErrs[ctx.p0DataIndex]);
                                return value > BALANCE_THRESHOLD ? 'rgb(239, 68, 68)' : 'rgb(168, 85, 247)';
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'ì‹œê°„ (ì´ˆ)', font: { weight: 'bold' } }
                        },
                        y: {
                            title: { display: true, text: 'ê· í˜• ì˜¤ì°¨ ê°’', font: { weight: 'bold' } },
                            ticks: { callback: value => value.toFixed(0) }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        annotation: {
                            annotations: {
                                centerLine: {
                                    type: 'line',
                                    yMin: 0,
                                    yMax: 0,
                                    borderColor: 'rgba(0, 0, 0, 0.5)',
                                    borderWidth: 2,
                                    label: {
                                        content: 'ì™„ë²½í•œ ê· í˜• (0)',
                                        display: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        color: 'white'
                                    }
                                },
                                thresholdTop: {
                                    type: 'line',
                                    yMin: BALANCE_THRESHOLD,
                                    yMax: BALANCE_THRESHOLD,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `ê²½ê³  (+${BALANCE_THRESHOLD})`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        color: 'white'
                                    }
                                },
                                thresholdBottom: {
                                    type: 'line',
                                    yMin: -BALANCE_THRESHOLD,
                                    yMax: -BALANCE_THRESHOLD,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `ê²½ê³  (-${BALANCE_THRESHOLD})`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        color: 'white'
                                    }
                                },
                                goodZone: {
                                    type: 'box',
                                    yMin: -BALANCE_THRESHOLD,
                                    yMax: BALANCE_THRESHOLD,
                                    backgroundColor: 'rgba(34, 197, 94, 0.05)',
                                    borderWidth: 0
                                }
                            }
                        }
                    }
                }
            });

            // 3. ì†ë„ ì˜¤ì°¨ ê·¸ë˜í”„
            const ctx3 = document.getElementById(`stage${stage}SpeedChart`).getContext('2d');
            if (charts[`stage${stage}Speed`]) {
                charts[`stage${stage}Speed`].destroy();
            }

            charts[`stage${stage}Speed`] = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'ì†ë„ ì˜¤ì°¨ (ì¼ì •í• ìˆ˜ë¡ ì¢‹ìŒ)',
                        data: speedErrs,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.3,
                        fill: true,
                        segment: {
                            borderColor: (ctx) => {
                                const value = Math.abs(speedErrs[ctx.p0DataIndex]);
                                return value > SPEED_THRESHOLD ? 'rgb(239, 68, 68)' : 'rgb(34, 197, 94)';
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'ì‹œê°„ (ì´ˆ)', font: { weight: 'bold' } }
                        },
                        y: {
                            title: { display: true, text: 'ì†ë„ ì˜¤ì°¨ ê°’', font: { weight: 'bold' } },
                            ticks: { callback: value => value.toFixed(0) }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        annotation: {
                            annotations: {
                                thresholdTop: {
                                    type: 'line',
                                    yMin: SPEED_THRESHOLD,
                                    yMax: SPEED_THRESHOLD,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `ê²½ê³  (+${SPEED_THRESHOLD})`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        color: 'white'
                                    }
                                },
                                thresholdBottom: {
                                    type: 'line',
                                    yMin: -SPEED_THRESHOLD,
                                    yMax: -SPEED_THRESHOLD,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `ê²½ê³  (-${SPEED_THRESHOLD})`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        color: 'white'
                                    }
                                },
                                goodZone: {
                                    type: 'box',
                                    yMin: -SPEED_THRESHOLD,
                                    yMax: SPEED_THRESHOLD,
                                    backgroundColor: 'rgba(34, 197, 94, 0.05)',
                                    borderWidth: 0
                                }
                            }
                        }
                    }
                }
            });
        }

        function createOverlayTimeSeriesCharts(stage, stageDataList) {
            const MOVE_THRESHOLD = 50;
            const BALANCE_THRESHOLD = 40;
            const SPEED_THRESHOLD = 30;

            // ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (BPMë³„)
            const colors = [
                { border: 'rgb(59, 130, 246)', bg: 'rgba(59, 130, 246, 0.2)' },  // íŒŒë€ìƒ‰
                { border: 'rgb(239, 68, 68)', bg: 'rgba(239, 68, 68, 0.2)' }     // ë¹¨ê°„ìƒ‰
            ];

            // 1. ë™ì‘ ì˜¤ì°¨ ì¤‘ì²© ê·¸ë˜í”„
            const ctx1 = document.getElementById(`stage${stage}MoveChart`).getContext('2d');
            if (charts[`stage${stage}Move`]) {
                charts[`stage${stage}Move`].destroy();
            }

            // BPM ê¸°ë°˜ ì‹œê°„ ê³„ì‚°
            const moveDatasets = stageDataList.map((item, idx) => {
                let moveErrs = parseArrayField(item.data.move_err);
                moveErrs = trimPrepAndFinish(moveErrs, 150); // ì¤€ë¹„/ë§ˆë¬´ë¦¬ ìì„¸ ì œê±°
                return {
                    label: `BPM ${item.bpm}`,
                    data: moveErrs,
                    borderColor: colors[idx % colors.length].border,
                    backgroundColor: colors[idx % colors.length].bg,
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.3,
                    fill: false
                };
            });

            // ì‹œê°„ ë ˆì´ë¸” ìƒì„± (BPM ê¸°ì¤€, íŠ¸ë¦¬ë° í›„ ë°ì´í„° ê¸¸ì´ ê¸°ì¤€)
            const maxLength = Math.max(...stageDataList.map(item => {
                let arr = parseArrayField(item.data.move_err);
                return trimPrepAndFinish(arr, 150).length;
            }));
            const firstBpm = stageDataList[0].bpm;
            const secondsPerBeat = 60 / firstBpm; // BPM 80 â†’ 0.75ì´ˆ, BPM 100 â†’ 0.6ì´ˆ
            const timeLabels = Array.from({length: maxLength}, (_, i) => (i * secondsPerBeat).toFixed(1));

            charts[`stage${stage}Move`] = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: moveDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'ì‹œê°„ (ì´ˆ)', font: { size: 14, weight: 'bold' } }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'ì˜¤ì°¨ ê°’', font: { size: 14, weight: 'bold' } },
                            ticks: { callback: value => value.toFixed(0) }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { size: 12, weight: 'bold' } }
                        },
                        annotation: {
                            annotations: {
                                threshold: {
                                    type: 'line',
                                    yMin: MOVE_THRESHOLD,
                                    yMax: MOVE_THRESHOLD,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `ê²½ê³  ê¸°ì¤€ (${MOVE_THRESHOLD})`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        color: 'white'
                                    }
                                },
                                goodZone: {
                                    type: 'box',
                                    yMin: 0,
                                    yMax: MOVE_THRESHOLD,
                                    backgroundColor: 'rgba(34, 197, 94, 0.05)',
                                    borderWidth: 0
                                }
                            }
                        }
                    }
                }
            });

            // 2. ê· í˜• ì˜¤ì°¨ ì¤‘ì²© ê·¸ë˜í”„
            const ctx2 = document.getElementById(`stage${stage}BalanceChart`).getContext('2d');
            if (charts[`stage${stage}Balance`]) {
                charts[`stage${stage}Balance`].destroy();
            }

            const balanceDatasets = stageDataList.map((item, idx) => {
                let balanceErrs = parseArrayField(item.data.balance_err);
                balanceErrs = trimPrepAndFinish(balanceErrs, 150); // ì¤€ë¹„/ë§ˆë¬´ë¦¬ ìì„¸ ì œê±°
                return {
                    label: `BPM ${item.bpm}`,
                    data: balanceErrs,
                    borderColor: colors[idx % colors.length].border,
                    backgroundColor: colors[idx % colors.length].bg,
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.3,
                    fill: false
                };
            });

            charts[`stage${stage}Balance`] = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: balanceDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'ì‹œê°„ (ì´ˆ)', font: { size: 14, weight: 'bold' } }
                        },
                        y: {
                            title: { display: true, text: 'ê· í˜• ì˜¤ì°¨ ê°’', font: { size: 14, weight: 'bold' } },
                            ticks: { callback: value => value.toFixed(0) }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { size: 12, weight: 'bold' } }
                        },
                        annotation: {
                            annotations: {
                                centerLine: {
                                    type: 'line',
                                    yMin: 0,
                                    yMax: 0,
                                    borderColor: 'rgba(0, 0, 0, 0.5)',
                                    borderWidth: 2,
                                    label: {
                                        content: 'ì™„ë²½í•œ ê· í˜• (0)',
                                        display: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        color: 'white'
                                    }
                                },
                                thresholdTop: {
                                    type: 'line',
                                    yMin: BALANCE_THRESHOLD,
                                    yMax: BALANCE_THRESHOLD,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `ê²½ê³  (+${BALANCE_THRESHOLD})`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        color: 'white'
                                    }
                                },
                                thresholdBottom: {
                                    type: 'line',
                                    yMin: -BALANCE_THRESHOLD,
                                    yMax: -BALANCE_THRESHOLD,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `ê²½ê³  (-${BALANCE_THRESHOLD})`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        color: 'white'
                                    }
                                },
                                goodZone: {
                                    type: 'box',
                                    yMin: -BALANCE_THRESHOLD,
                                    yMax: BALANCE_THRESHOLD,
                                    backgroundColor: 'rgba(34, 197, 94, 0.05)',
                                    borderWidth: 0
                                }
                            }
                        }
                    }
                }
            });

            // 3. ì†ë„ ì˜¤ì°¨ ì¤‘ì²© ê·¸ë˜í”„
            const ctx3 = document.getElementById(`stage${stage}SpeedChart`).getContext('2d');
            if (charts[`stage${stage}Speed`]) {
                charts[`stage${stage}Speed`].destroy();
            }

            const speedDatasets = stageDataList.map((item, idx) => {
                let speedErrs = parseArrayField(item.data.speed_err);
                speedErrs = trimPrepAndFinish(speedErrs, 150); // ì¤€ë¹„/ë§ˆë¬´ë¦¬ ìì„¸ ì œê±°
                return {
                    label: `BPM ${item.bpm}`,
                    data: speedErrs,
                    borderColor: colors[idx % colors.length].border,
                    backgroundColor: colors[idx % colors.length].bg,
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.3,
                    fill: false
                };
            });

            charts[`stage${stage}Speed`] = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: speedDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'ì‹œê°„ (ì´ˆ)', font: { size: 14, weight: 'bold' } }
                        },
                        y: {
                            title: { display: true, text: 'ì†ë„ ì˜¤ì°¨ ê°’', font: { size: 14, weight: 'bold' } },
                            ticks: { callback: value => value.toFixed(0) }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { size: 12, weight: 'bold' } }
                        },
                        annotation: {
                            annotations: {
                                thresholdTop: {
                                    type: 'line',
                                    yMin: SPEED_THRESHOLD,
                                    yMax: SPEED_THRESHOLD,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `ê²½ê³  (+${SPEED_THRESHOLD})`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        color: 'white'
                                    }
                                },
                                thresholdBottom: {
                                    type: 'line',
                                    yMin: -SPEED_THRESHOLD,
                                    yMax: -SPEED_THRESHOLD,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `ê²½ê³  (-${SPEED_THRESHOLD})`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        color: 'white'
                                    }
                                },
                                goodZone: {
                                    type: 'box',
                                    yMin: -SPEED_THRESHOLD,
                                    yMax: SPEED_THRESHOLD,
                                    backgroundColor: 'rgba(34, 197, 94, 0.05)',
                                    borderWidth: 0
                                }
                            }
                        }
                    }
                }
            });
        }

        // BPM í•„í„° ì´ë²¤íŠ¸
        document.querySelectorAll('.bpm-filter').forEach(checkbox => {
            checkbox.addEventListener('change', renderOverviewTab);
        });
    </script>
</body>
</html>
